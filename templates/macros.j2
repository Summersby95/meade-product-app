{% macro form_builder(field_array, product=None, context=None) %}
    {% for field in field_array %}
        {# build form elements from field_list #}
        {% if product != None %}
            {% if session.role != "Commercial" %}

                {% if (session.role.lower()) in product %}
                    {# check if the product object already has an attribute for the field and if it does, 
                        set it as the value for the element #}
                    {% if context != None %} 
                        {% if context in product[(session.role.lower())] %}
                            {% if field.field_name in product[(session.role.lower())][context] %}
                                {% set value = product[(session.role.lower())][context][field.field_name] %}
                            {% else %}
                                {% set value = "" %}
                            {% endif %}
                        {% else %} 
                            {% set value = "" %}
                        {% endif %}
                    {% else %}
                        {% if field.field_name in product[(session.role.lower())] %}
                            {% set value = product[(session.role.lower())][field.field_name] %}
                        {% else %} 
                            {% set value = "" %} 
                        {% endif %}
                    {% endif %}

                    
                {% else %} 
                    {% set value = "" %}
                {% endif %}
            
            {% else %}

                {% if field.field_name in product %}
                    {% set value = product[field.field_name] %}
                {% else %}
                    {% set value = "" %}
                {% endif %}
            
            {% endif %}
        {% else %}
            {% set value = "" %}
        {% endif %}

        {% if field.field_type == "input" %} 

            <div class="input-field col s12 m6">
                <input type="{{ field.input_type }}" class="validate" name="{{ field.field_name }}" id="{{ field.field_name }}" value="{{ value }}" required>
                <label for="{{ field.field_name }}">{{ field.field_name.replace("_", " ").title() }}</label>
            </div>

        {% elif field.field_type == "date" %}

            <div class="input-field col s12 m6">
                <input type="text" class="datepicker validate" name="{{ field.field_name }}" id="{{ field.field_name }}" value="{{ value }}" required>
                <label for="{{ field.field_name }}">{{ field.field_name.replace("_", " ").title() }}</label>
            </div>

        {% elif field.field_type == "multiselect" %}

            <div class="input-field col s12 m6">
                <select multiple name="{{ field.field_name }}" id="{{ field.field_name }}" required>
                    
                    {% for option in field.options %} 

                        {% if value is iterable and (value is not string and value is not mapping) %}
                            {% if option in value %} 
                                {% set sel = "selected" %} 
                            {% else %} 
                                {% set sel = "" %}
                            {% endif %}
                        {% else %} 
                            {% set sel = "" %} 
                        {% endif %}

                        <option value="{{ option }}" {{ sel }}>{{ option }}</option>
                    {% endfor %}
                </select>
                <label for="{{ field.field_name }}">{{ field.field_name.replace("_", " ").title() }}</label>
            </div>
        
        {% elif field.field_type == "select" %}

            <div class="input-field col s12 m6">
                <select name="{{ field.field_name }}" id="{{ field.field_name }}" required>
                    {% for option in field.options %} 
                        {% if option == value %}
                            {% set sel = "selected" %} 
                        {% else %} 
                            {% set sel = "" %} 
                        {% endif %} 

                        <option value="{{ option }}" {{ sel }}>{{ option }}</option>
                    {% endfor %}
                </select>
                <label for="{{ field.field_name }}">{{ field.field_name.replace("_", " ").title() }}</label>
            </div>

        {% elif field.field_type == "spec_grid" %}
            <div class="col s12 row">
                <table class="striped responsive-table">
                    <thead>
                        <tr>
                            <th>Defect</th>
                            <th>R/A/G</th>
                            <th>Tolerance (%)</th>
                            <th>Comments</th>
                        </tr>
                    </thead>

                    <tbody>
                        {% for spec in field.options %}

                            {% if session.role.lower() in product %}
                                {% if field.field_name in product[session.role.lower()] %}
                                    {% if spec.replace(' ', '_').lower() in product[session.role.lower()][field.field_name] %}
                                        {% set value = product[session.role.lower()][field.field_name][spec.replace(' ', '_').lower()] %}
                                    {% else %}
                                        {% set value = "" %}
                                    {% endif %}
                                {% else %}
                                    {% set value = "" %}
                                {% endif %}
                            {% else %}
                                {% set value = "" %}
                            {% endif %}

                            <tr>
                                <td>{{ spec }}</td>
                                <td>
                                    <select class="validate" name="{{ spec.replace(' ', '_').lower() }}_rag" id="{{ spec.replace(' ', '_').lower() }}_rag">
                                        {% set rag_options = ["Green","Amber","Red"] %}
                                        {% for rag_opt in rag_options %}
                                            {% if value.rag == rag_opt %}
                                                {% set sel = "selected" %}
                                            {% else %}
                                                {% set sel = "" %}
                                            {% endif %}

                                            <option value="{{ rag_opt }}" {{ sel }}>{{ rag_opt }}</option>
                                        {% endfor %}
                                        
                                    </select>
                                </td>
                                <td>
                                    <input type="number" class="validate" name="{{ spec.replace(' ', '_').lower() }}_tol" id="{{ spec.replace(' ', '_').lower() }}_tol" value="{{ value.tolerance }}">
                                </td>
                                <td>
                                    <input type="text" class="validate" name="{{ spec.replace(' ', '_').lower() }}_com" id="{{ spec.replace(' ', '_').lower() }}_com" value="{{ value.comments }}">
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

        {% endif %}

    {% endfor %}
    
{% endmacro %}

{% macro view_builder(product_details, context=None) %}

    {% for field, value in product_details %} 
        {% if value is mapping and context == None %}

            <div class="col s12">
                <h5><strong><i>{{ field.replace("_", " ").title() }}</i></strong></h5>
            </div>

            {% if field == "quality_specification" %}

                <div class="col s12">
                    <table class="striped responsive-table">
                        <thead>
                            <tr>
                                <th>Defect</th>
                                <th>R/A/G</th>
                                <th>Tolerance (%)</th>
                                <th>Comments</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for defect, def_details in value.items() %}

                                <tr>
                                    <th>{{ defect.replace("_", " ").title() }}
                                    <td>{{ def_details.rag }}</td>
                                    <td>{{ def_details.tolerance }}</td>
                                    <td>{{ def_details.comments }}</td>
                                </tr>

                            {% endfor %}
                        </tbody>
                    </table>
                </div>

            {% else %}

                {% for sub_field, sub_val in value.items() %} 

                    <div class="col s12 m6 row">
                        <div class="col s4">
                            <strong>{{ sub_field.replace("_", " ").title() }}</strong>
                        </div>
                        <div class="col s8">
                            {% if sub_val is iterable and (sub_val is not string and sub_val is not mapping) %}
                                {{ ", ".join(sub_val) }}
                            {% else %}  
                                {{ sub_val }}
                            {% endif %} 
                        </div>
                    </div>

                {% endfor %}

            {% endif %}

        {% elif value is not mapping and field != "_id" %} 
            <div class="col s12 m6 row">
                <div class="col s4">
                    <strong>{{ field.replace("_", " ").title() }}</strong>
                </div>
                <div class="col s8">
                    {% if value is iterable and (value is not string and value is not mapping) %}
                        {{ ", ".join(value) }}
                    {% else %}  
                        {{ value }}
                    {% endif %} 
                </div>
            </div>
        {% endif %}
        

    {% endfor %}

{% endmacro %}

{% macro table_builder(product_list, context=None) %}

    <table class="highlight responsive-table">
